<template>
  <form @submit.prevent="handleSubmit">
    <div class="container-sm px-3">
      <Box class="d-flex">
        <div class="flex-auto">
          <label for="input" class="d-block">
            Input
            <LabelBalance :asset="inputAsset" @select="selectAmount" />
          </label>
          <InputAmount
            id="input"
            v-model="inputAmount"
            @change="updateOutputAmount"
            :asset="inputAsset"
          />
        </div>
        <div class="text-right mt-4 d-flex">
          <a class="ml-2 p-2 color-gray-6" @click="switchAssets"><Icon name="switch"/></a>
          <ButtonSelectToken
            :default="inputAsset || 'base'"
            :not="outputAsset"
            v-model="inputAsset"
          />
        </div>
      </Box>
      <Box class="d-flex">
        <div class="flex-auto">
          <label for="output" class="d-block">Output</label>
          <InputAmount
            id="output"
            v-model="outputAmount"
            @change="updateInputAmount"
            :asset="outputAsset"
          />
        </div>
        <div class="text-right mt-4 d-flex">
          <a class="ml-2 p-2 color-gray-6" @click="switchAssets"><Icon name="switch"/></a>
          <ButtonSelectToken :default="outputAsset" :not="inputAsset" v-model="outputAsset" />
        </div>
      </Box>
      <Box v-if="$route.name === 'send'">
        <label for="to" class="d-block">Recipient address</label>
        <input
          id="to"
          type="text"
          autocomplete="off"
          class="form-control input-amount border-0 p-0"
          placeholder="FAB6TH7I..."
          v-model="to"
        />
      </Box>
      <Box v-if="rate">
        <label for="input">Average price</label>
        <div class="text-white">
          1 <Ticker :asset="outputAsset" /> =
          {{ parseFloat(rate.toFixed(this.getDecimals(inputAsset))) }}
          <Ticker :asset="inputAsset" />
        </div>
        <div class="text-white">
          1 <Ticker :asset="inputAsset" /> =
          {{ parseFloat((1 / rate).toFixed(this.getDecimals(outputAsset))) }}
          <Ticker :asset="outputAsset" />
        </div>
      </Box>
      <Box v-else-if="tooMuch">
        <p class="m-0">
          The price would change too much, try a smaller amount.
        </p>
      </Box>
      <BoxSelectThreshold v-model="bounceThreshold" />
      <div class="text-center mb-4">
        <button
          class="btn-submit px-6 rounded-2 mb-4"
          type="submit"
          :disabled="!inputAsset || !outputAsset || !inputAmount || !outputAmount || needLogin || tooMuch"
        >
          <template v-if="$route.name === 'send'">Send</template>
          <template v-else>Swap</template>
        </button>
        <div v-if="needLogin">This swap would be multi-hop, please <a :href="invite">log in</a> to use it.</div>
      </div>
    </div>
  </form>
</template>

<script>
import Trade from '@/helpers/_oswap/trade';
import Factory from '@/helpers/_oswap/factory';
import { getInfo, generateUri, toString } from '@/helpers/_oswap';
import { b64UriDec } from '@/helpers/utils';

export default {
  data() {
    return {
      id: b64UriDec(
        this.$route.params.poolAddress ||
          this.$route.params[0] ||
          this.$route.params.pathMatch ||
          ''
      ),
      trade: false,
      inputAsset: '',
      outputAsset: '',
      inputAmount: '',
      outputAmount: '',
      multiHop: false,
      tooMuch: false,
      bounceThreshold: 1,
      to: this.$route.query.to,
      rate: 0
    };
  },
  async created() {
    if (this.id.length === 44) {
      this.outputAsset = this.id;
      [this.inputAsset, this.outputAsset] = this.$route.query.reverse
        ? [this.outputAsset, 'base']
        : ['base', this.outputAsset];
    } else if (this.id) {
      const {info} = await getInfo(this.id);
      if (info && Object.keys(info).length) {
        [this.inputAsset, this.outputAsset] = this.$route.query.reverse
          ? [info.y_asset, info.x_asset]
          : [info.x_asset, info.y_asset];
      }
    }
  },
  watch: {
    async inputAsset(value, oldValue) {
      if (value !== oldValue) {
        await this.init();
        this.updateOutputAmount();
      }
    },
    async outputAsset(value, oldValue) {
      if (value !== oldValue) {
        await this.init();
        this.updateOutputAmount();
      }
    }
  },
  computed: {
    needLogin(){
      return this.multiHop && this.$route.name !== 'send' && !this.auth.address;
    },
    invite(){
      return `${this.auth.invite}#login`;
    },
    share(){
      return this.bounceThreshold === 100 ? 0.99 : 1 - this.bounceThreshold/100;
    },
  },
  methods: {
    getDecimals(assetId) {
      return this.settings.decimals[assetId] || 0;
    },
    updateRate() {
      if (!this.inputAsset || !this.outputAsset) {
        this.rate = 0;
        return;
      }
      const inputAmount = toString(this.inputAmount * this.share, this.getDecimals(this.inputAsset));
      const outputAmount = toString(this.outputAmount, this.getDecimals(this.outputAsset));
      const rate = parseFloat((inputAmount / outputAmount).toPrecision(6));
      if (rate <= 0 || rate === Infinity) {
        this.rate = 0;
        return;
      }
      this.rate = rate;
    },
    selectAmount(amount) {
      this.inputAmount = amount;
      this.updateOutputAmount();
    },
    async switchAssets() {
      [this.inputAsset, this.outputAsset] = [this.outputAsset, this.inputAsset];
      this.outputAmount = '';
      this.inputAmount = '';
      await this.init();
    },
    async init() {
      if (!this.inputAsset || !this.outputAsset) return;
      const settings = this.settings;
      const factory = new Factory(settings.pools, settings.pairs);
      this.trade = new Trade(factory, this.inputAsset, this.outputAsset);
      await this.trade.init();
    },
    handleSubmit() {
      let min_amount_out = 0;
      if (this.bounceThreshold < 100) {
        if (!this.bounceThreshold) {
          min_amount_out = this.outputAmount;
        } else {
          min_amount_out = Math.round(this.outputAmount * (1 - this.bounceThreshold / 100));
        }
      }
      const {route, data} = this.trade.getAmountBoughtAndData(this.inputAmount, this.share);
      const last_hop = data.hops ? data.hops[data.hops.length-1] : null;
      const last_hop_data = data.hops ? last_hop.data : data;
      if (min_amount_out)
        last_hop_data.min_amount_out = min_amount_out;
      const address = route.pools[0].address;
      const change_address = this.auth.address || this.$route.name === 'send' && this.to;
      if (change_address && data.hops)
        data.hops.forEach(hop => {
          hop.change_address = change_address;
        });
      if (this.to && this.$route.name === 'send') {
        if (!data.hops)
          data.hops = [];
        data.hops.push({address: this.to});
      }
      else{
        if (data.hops)
          data.hops.push({address: this.auth.address});
      }
      console.log('data', data)
      const url = generateUri(address, data, this.inputAmount, this.inputAsset);

      this.track();

      if (navigator.userAgent.indexOf('Firefox') != -1) {
        const opener = window.open(url, '', 'width=1,height=1,resizable=no');
        setTimeout(function() {
          opener.close();
        }, 5000);
      } else {
        location.href = url;
      }
    },
    updateOutputAmount() {
      if (!this.inputAsset || !this.outputAsset) return;
      if (this.inputAmount) {
        const {net_amount_out, data, route} = this.trade.getAmountBoughtAndData(this.inputAmount, this.share);
        if (route) {
          this.outputAmount = net_amount_out || '';
          this.multiHop = !!data.hops;
          this.tooMuch = false;
          this.updateRate();
        }
        else {
          console.log('no suitable route found');
          this.tooMuch = true;
          this.rate = null;
        }
      }
    },
    updateInputAmount() {
      if (!this.inputAsset || !this.outputAsset) return;
      if (this.outputAmount){
        const inputAmount = this.trade.getAmountSold(this.outputAmount, this.share) || '';
        if (inputAmount) {
          this.inputAmount = inputAmount;
          this.tooMuch = false;
          this.updateRate();
        }
        else {
          console.log('no suitable route found');
          this.tooMuch = true;
          this.rate = null;
        }
      }
    },
    track() {
      this.$gtag.event('swap', {
        event_category: 'swap page',
        event_label: 'assets',
        value: `${this.inputAsset}_${this.outputAsset}`
      });
    }
  }
};
</script>
